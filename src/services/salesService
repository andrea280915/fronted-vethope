// services/salesService.js
import axios from "axios";

const API_URL = "https://backend-vethope-production.up.railway.app/api/v1/ventas";

const getAuthHeader = () => {
  const token = localStorage.getItem("token");
  console.log("Token obtenido:", token ? "Presente" : "No encontrado");
  
  return token ? { 
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  } : { 'Content-Type': 'application/json' };
};

const salesService = {
  getAll: async () => {
    try {
      const res = await axios.get(API_URL, { headers: getAuthHeader() });
      return res.data;
    } catch (err) {
      console.error("Error en getAllVentas:", err.response?.data || err.message);
      throw new Error(err.response?.data?.message || "Error al obtener lista de ventas");
    }
  },

  getById: async (id) => {
    try {
      const res = await axios.get(`${API_URL}/${id}`, { headers: getAuthHeader() });
      return res.data;
    } catch (err) {
      console.error("Error en getVentaById:", err.response?.data || err.message);
      throw new Error(err.response?.data?.message || "Error al obtener venta por ID");
    }
  },

  create: async (venta) => {
    try {
      console.log("Enviando venta con headers:", getAuthHeader());
      console.log("Payload:", venta);
      
      const res = await axios.post(API_URL, venta, { 
        headers: getAuthHeader() 
      });
      
      console.log("Venta creada exitosamente:", res.data);
      return res.data;
    } catch (err) {
      console.error("Error en createVenta:", err.response?.status);
      console.error("Detalles del error:", err.response?.data);
      console.error("Headers enviados:", err.config?.headers);
      
      let errorMessage = "Error al registrar venta";
      
      if (err.response?.status === 401 || err.response?.status === 403) {
        errorMessage = "Acceso denegado. Token inválido o expirado. Por favor, inicie sesión nuevamente.";
      } else if (err.response?.status === 400) {
        errorMessage = "Datos inválidos: " + (err.response?.data?.message || "Verifique los datos enviados");
      } else if (err.response?.status === 404) {
        errorMessage = "Recurso no encontrado";
      }
      
      throw new Error(errorMessage);
    }
  },

  update: async (id, venta) => {
    try {
      const res = await axios.put(`${API_URL}/${id}`, venta, { headers: getAuthHeader() });
      return res.data;
    } catch (err) {
      console.error("Error en updateVenta:", err.response?.data || err.message);
      throw new Error(err.response?.data?.message || "Error al actualizar venta");
    }
  },

  delete: async (id) => {
    try {
      const res = await axios.delete(`${API_URL}/${id}`, { headers: getAuthHeader() });
      return res.data;
    } catch (err) {
      console.error("Error en deleteVenta:", err.response?.data || err.message);
      throw new Error(err.response?.data?.message || "Error al eliminar venta");
    }
  }
};

export default salesService;
